<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>De-ID Text Inspector (í”„ë¡ íŠ¸ ì „ìš©)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- pdf.js (í…ìŠ¤íŠ¸ ì¶”ì¶œ/ë¯¸ë¦¬ë³´ê¸°) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    // ë°±ì—”ë“œ ë¶™ì¼ ë•Œë§Œ ì„¤ì •: window.API_BASE = 'http://localhost:8787';
  </script>
  <style>
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    mark{ padding: 0 .15rem; border-radius: .2rem; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">ğŸ›¡ï¸ De-ID Text Inspector (PDF í…ìŠ¤íŠ¸ ì¶”ì¶œÂ·ì •ê·œí™”Â·ë§¤ì¹­)</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- LEFT: Controls -->
      <div class="bg-white rounded-2xl shadow p-5 space-y-4">
        <div>
          <label class="block text-sm font-semibold mb-1">íŒŒì¼ ì—…ë¡œë“œ (PDF ê¶Œì¥)</label>
          <input id="file" type="file" accept=".pdf,.txt,text/plain" class="block w-full border rounded p-2 bg-white" />
          <p class="text-xs text-gray-500 mt-1">* PDFëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì¶”ì¶œ(pdf.js), TXTëŠ” ê·¸ëŒ€ë¡œ ì½ìŒ</p>
        </div>

        <fieldset class="border rounded p-3">
          <legend class="text-sm font-semibold">ê·œì¹™ ì„ íƒ</legend>
          <label class="block"><input type="checkbox" name="rule" value="rrn" checked> ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ (í˜•ì‹+ë‚ ì§œ, <span class="text-xs">ì˜µì…˜: ì²´í¬ì„¬</span>)</label>
          <label class="block"><input type="checkbox" name="rule" value="phone_mobile" checked> íœ´ëŒ€ì „í™”(010)</label>
          <label class="block"><input type="checkbox" name="rule" value="phone_city" checked> ì§€ì—­ì „í™”(02/031~064)</label>
          <label class="block"><input type="checkbox" name="rule" value="email" checked> ì´ë©”ì¼</label>
          <label class="block"><input type="checkbox" name="rule" value="card" checked> ì¹´ë“œë²ˆí˜¸ (Luhn)</label>
          <label class="block"><input type="checkbox" name="rule" value="bizno" checked> ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ (ì²´í¬ì„¬)</label>
        </fieldset>

        <div class="flex items-center gap-3">
          <label class="inline-flex items-center gap-2"><input id="opt-rrn-checksum" type="checkbox"> ì£¼ë¯¼ë²ˆí˜¸ ì²´í¬ì„¬ë„ ê²€ì‚¬</label>
          <label class="inline-flex items-center gap-2"><input id="opt-normalize" type="checkbox" checked> í…ìŠ¤íŠ¸ ì •ê·œí™” ì‚¬ìš©</label>
        </div>

        <div class="flex items-center gap-3">
          <button id="btn-scan" class="px-4 py-2 rounded bg-blue-600 text-white">ìŠ¤ìº” ì‹¤í–‰</button>
          <button id="btn-export" class="px-3 py-2 rounded border">ë¦¬í¬íŠ¸ JSON ì €ì¥</button>
          <span id="status" class="text-sm text-gray-600"></span>
        </div>

        <div class="border-t pt-3">
          <label class="inline-flex items-center gap-2"><input id="opt-backend" type="checkbox"> ë°±ì—”ë“œ ì‚¬ìš©(API)</label>
          <p class="text-xs text-gray-500">* ì²´í¬í•˜ë©´ window.API_BASEë¡œ POST /extract, /match ë“±ì„ í˜¸ì¶œí•˜ë„ë¡ ë°”ê¿€ ìˆ˜ ìˆì–´ìš” (ë°±ì—”ë“œ ì¤€ë¹„ë˜ë©´)</p>
        </div>
      </div>

      <!-- RIGHT: Preview / Results -->
      <div class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-2xl shadow p-5">
          <h2 class="font-semibold mb-2">PDF ë¯¸ë¦¬ë³´ê¸°(1í˜ì´ì§€)</h2>
          <canvas id="pdf-preview" class="w-full border rounded"></canvas>
        </div>

        <div class="bg-white rounded-2xl shadow p-5">
          <h2 class="font-semibold mb-2">ì¶”ì¶œ í…ìŠ¤íŠ¸ (ì •ê·œí™” ì ìš©ë³¸ ë¯¸ë¦¬ë³´ê¸°)</h2>
          <textarea id="txt-out" class="w-full h-48 border rounded p-2 mono" readonly></textarea>
        </div>

        <div class="bg-white rounded-2xl shadow p-5">
          <h2 class="font-semibold mb-2">ë§¤ì¹­ ê²°ê³¼</h2>
          <div id="summary" class="text-sm text-gray-700 mb-2"></div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="border-b">
                  <th class="text-left py-2 px-2">Rule</th>
                  <th class="text-left py-2 px-2">Match</th>
                  <th class="text-left py-2 px-2">Valid</th>
                  <th class="text-left py-2 px-2">Context</th>
                </tr>
              </thead>
              <tbody id="result-rows"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   0) ìœ í‹¸/ì •ê·œí™” (ì¹œêµ¬ ì½”ë“œ JS í¬íŒ…)
   ========================= */
const ZERO_WIDTH = /[\u200B\u200C\u200D\u2060\ufeff]/g;           // ì œë¡œí­/ì œì–´
const NBSP       = /[\u00A0\u2007\u202F]/g;                        // íŠ¹ìˆ˜ ê³µë°±
const DASHES     = /[\u2010\u2011\u2012\u2013\u2014\u2212\ufe63\u2043]/g; // ëŒ€ì‹œë¥˜
function stripInvisible(s){ return s.replace(ZERO_WIDTH, '').replace(NBSP, ' '); }
function normalizeText(s){
  if(!s) return s;
  s = s.normalize('NFKC');                   // 1) ìœ ë‹ˆì½”ë“œ ì •ê·œí™”
  s = s.replace(/\r\n?/g, '\n');             // 2) ê°œí–‰ í†µì¼
  s = stripInvisible(s);                     // 3) ë³´ì´ì§€ ì•ŠëŠ” ë¬¸ì ì œê±°
  s = s.replace(DASHES, '-');                // 4) ëŒ€ì‹œ í†µì¼
  s = s.replace(/\t/g, ' ')
       .replace(/[ \f\v]+/g, ' ')
       .split('\n').map(line=>line.replace(/[ \t]+$/,'')).join('\n'); // 5) ê³µë°± ì •ë¦¬
  return s;
}
const digitsOnly = s => (s||'').replace(/\D+/g, '');

/* ---------- ê²€ì¦ê¸° ---------- */
// ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸
const RRN_RE = /^(\d{6})-([0-9]{7})$/;
function inferCentury(year2, s7){
  if([1,2,5,6].includes(s7)) return 1900 + year2;
  if([3,4,7,8].includes(s7)) return 2000 + year2;
  return null;
}
function validDateYYYYMMDD(yyMMdd, s7){
  const yy = parseInt(yyMMdd.slice(0,2),10);
  const mm = parseInt(yyMMdd.slice(2,4),10);
  const dd = parseInt(yyMMdd.slice(4,6),10);
  const yyyy = inferCentury(yy, s7);
  if(yyyy==null) return false;
  const d = new Date(yyyy, mm-1, dd);
  if(d.getFullYear()!==yyyy || d.getMonth()!==mm-1 || d.getDate()!==dd) return false;
  return d <= new Date();
}
function isValidRRNDateOnly(rrn){
  const m = (rrn||'').match(RRN_RE);
  if(!m) return false;
  const front = m[1], back = m[2]; const s7 = parseInt(back[0],10);
  return validDateYYYYMMDD(front, s7);
}
function isValidRRNChecksum(rrn){
  const m = (rrn||'').match(RRN_RE);
  if(!m) return false;
  const s = (m[1]+m[2]);
  if(s.length!==13 || /\D/.test(s)) return false;
  const digits = [...s].map(c=>c.charCodeAt(0)-48);
  const weights = [2,3,4,5,6,7,8,9,2,3,4,5];
  const total = weights.reduce((acc,w,i)=>acc + digits[i]*w, 0);
  const check = (11 - (total % 11)) % 10;
  return check === digits[12];
}
function isValidRRN(rrn, useChecksum=false){
  if(!isValidRRNDateOnly(rrn)) return false;
  return useChecksum ? isValidRRNChecksum(rrn) : true;
}
// íœ´ëŒ€ì „í™” 010
function isValidPhoneMobile(number){
  const d = digitsOnly(number);
  return d.startsWith('010') && d.length===11;
}
// ì§€ì—­ì „í™”
const AREACODE_RE = /^(?:02|0(?:3[1-3]|4[1-4]|5[1-5]|6[1-4]))/;
function isValidPhoneCity(number){
  const d = digitsOnly(number);
  if(!AREACODE_RE.test(d)) return false;
  return d.startsWith('02') ? [9,10].includes(d.length) : [10,11].includes(d.length);
}
// ì´ë©”ì¼
const EMAIL_STRICT = /^[A-Za-z0-9._%+-]+@(?:[A-Za-z0-9-]+\.)+[A-Za-z]{2,}$/;
function isValidEmail(addr){ return EMAIL_STRICT.test((addr||'').trim()); }
// ì¹´ë“œ Luhn
function luhnCheck(number){
  const d = digitsOnly(number);
  if(d.length<13 || d.length>19) return false;
  let total=0, dbl=false;
  for(let i=d.length-1;i>=0;i--){
    let n = d.charCodeAt(i)-48;
    if(dbl){ n*=2; if(n>9) n-=9; }
    total+=n; dbl=!dbl;
  }
  return total%10===0;
}
function isValidCard(n){ return luhnCheck(n); }
// ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ì²´í¬ì„¬
function isValidBizNo(bno){
  const d = digitsOnly(bno);
  if(d.length!==10) return false;
  const nums = [...d].map(c=>c.charCodeAt(0)-48);
  const ws = [1,3,7,1,3,7,1,3,5];
  let s=0;
  for(let i=0;i<9;i++) s += nums[i]*ws[i];
  s += Math.floor((nums[8]*5)/10);
  const check = (10 - (s % 10)) % 10;
  return check === nums[9];
}

/* ---------- ê·œì¹™(ì •ê·œì‹) ---------- */
const RULES = {
  rrn:          { id:'rrn',          re: /\b\d{6}-[1-8]\d{6}\b/g,            validate: (s,opts)=>isValidRRN(s, opts.rrnChecksum) },
  phone_mobile: { id:'phone_mobile', re: /\b010[-.\s]?\d{3,4}[-.\s]?\d{4}\b/g, validate: isValidPhoneMobile },
  phone_city:   { id:'phone_city',   re: /\b(?:02|0(?:3[1-3]|4[1-4]|5[1-5]|6[1-4]))[-.\s]?\d{3,4}[-.\s]?\d{4}\b/g, validate: isValidPhoneCity },
  email:        { id:'email',        re: /\b[a-zA-Z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/g, validate: isValidEmail },
  // ì¹´ë“œ: lookbehind ë¯¸ì§€ì› ë¸Œë¼ìš°ì € ëŒ€ë¹„, ê²½ê³„ í•„í„°ëŠ” ì½”ë“œì—ì„œ ì²˜ë¦¬
  card:         { id:'card',         re: /(?:\d[ -]?){13,19}/g,              validate: s => isValidCard(s) },
  bizno:        { id:'bizno',        re: /\b\d{3}-?\d{2}-?\d{5}\b/g,          validate: isValidBizNo },
};

/* =========================
   1) PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ (í´ë¼)
   ========================= */
async function extractPdfClient(file){
  const arr = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arr}).promise;
  const pages = [];
  for(let i=1; i<=pdf.numPages; i++){
    const page = await pdf.getPage(i);
    const tc = await page.getTextContent();
    const text = tc.items.map(it => it.str).join(' ');
    pages.push({ pageNumber: i, text });
  }
  const full = pages.map(p => `\n\n===== [Page ${p.pageNumber}] =====\n${p.text}`).join('').replace(/^\s+/, '');
  return { fullText: full, pages, _pdf: pdf };
}

/* =========================
   2) ë¯¸ë¦¬ë³´ê¸°
   ========================= */
async function renderPdfPreview(file){
  if(!file || file.type!=='application/pdf') { 
    const c = document.getElementById('pdf-preview'); const g=c.getContext('2d'); g.clearRect(0,0,c.width,c.height); return;
  }
  const arr = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arr}).promise;
  const page = await pdf.getPage(1);
  const viewport = page.getViewport({scale: 1.2});
  const canvas = document.getElementById('pdf-preview');
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
}

/* =========================
   3) ë§¤ì¹­/ë¦¬í¬íŠ¸
   ========================= */
function contextSnippet(s, from, to, pad=30){
  const L = Math.max(0, from-pad), R = Math.min(s.length, to+pad);
  return s.slice(L, from) + 'ã€' + s.slice(from, to) + 'ã€‘' + s.slice(to, R);
}

function runMatch(text, pickedRules, opts){
  const results = [];
  for(const rid of pickedRules){
    const rule = RULES[rid]; if(!rule) continue;
    const re = new RegExp(rule.re, rule.re.flags.includes('g') ? rule.re.flags : (rule.re.flags+'g'));
    let m;
    while((m = re.exec(text))!==null){
      let val = m[0];
      // ì¹´ë“œ ê²½ê³„ ë³´ì •: ì•ë’¤ê°€ ìˆ«ìë©´ ìŠ¤í‚µ
      if(rid==='card'){
        const prev = text[m.index-1], next = text[m.index+val.length];
        if((prev && /\d/.test(prev)) || (next && /\d/.test(next))) continue;
      }
      const ok = rule.validate ? !!rule.validate(val, opts): true;
      results.push({ rule: rid, match: val, valid: ok, index: m.index, end: m.index+val.length });
    }
  }
  // ìš”ì•½
  const counts = pickedRules.reduce((acc, r)=> (acc[r]=results.filter(x=>x.rule===r).length, acc), {});
  return { results, counts };
}

/* =========================
   4) ì´ë²¤íŠ¸/íë¦„
   ========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
$('#file').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  renderPdfPreview(f).catch(()=>{});
});
$('#btn-scan').addEventListener('click', async ()=>{
  const f = $('#file').files[0];
  if(!f){ alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  $('#status').textContent = 'ì²˜ë¦¬ ì¤‘...';
  try{
    // 1) í…ìŠ¤íŠ¸ ì¶”ì¶œ
    let fullText = '';
    if(f.type==='application/pdf'){ 
      const res = await extractPdfClient(f);
      fullText = res.fullText;
    } else {
      fullText = await f.text();
    }
    // 2) ì •ê·œí™”
    const doNorm = $('#opt-normalize').checked;
    const text = doNorm ? normalizeText(fullText) : fullText;
    $('#txt-out').value = text.slice(0, 100000); // ë„ˆë¬´ ê¸¸ë©´ ë¯¸ë¦¬ë³´ê¸°ë§Œ
    // 3) ê·œì¹™ ì„ íƒ
    const picked = $$('#'+'frm rules'.replace(' ','')) // dummy to avoid IDE hints
    const pickedRules = $$('input[name="rule"]:checked').map(x=>x.value);
    // 4) ë§¤ì¹­
    const opts = { rrnChecksum: $('#opt-rrn-checksum').checked };
    const { results, counts } = runMatch(text, pickedRules, opts);
    // 5) í…Œì´ë¸” ë Œë”
    const tbody = $('#result-rows'); tbody.innerHTML = '';
    for(const r of results){
      const tr = document.createElement('tr'); tr.className='border-b align-top';
      const tdRule = `<td class="py-2 px-2 mono">${r.rule}</td>`;
      const tdMatch= `<td class="py-2 px-2 mono">${r.match}</td>`;
      const tdValid= `<td class="py-2 px-2 ${r.valid?'text-emerald-700':'text-rose-700'}">${r.valid?'OK':'FAIL'}</td>`;
      const snippet = contextSnippet(text, r.index, r.end, 25).replace(/</g,'&lt;');
      const tdCtx  = `<td class="py-2 px-2 mono">${snippet}</td>`;
      tr.innerHTML = tdRule+tdMatch+tdValid+tdCtx; tbody.appendChild(tr);
    }
    // 6) ìš”ì•½
    $('#summary').textContent = 'ê²€ì¶œ: ' + Object.entries(counts).map(([k,v])=>`${k}=${v}`).join(', ');
    // 7) ë¦¬í¬íŠ¸ ì €ì¥ìš© ì „ì—­
    window.__lastReport = { createdAt: new Date().toISOString(), counts, items: results.map(r=>({rule:r.rule, value:r.match, valid:r.valid})) };
    $('#status').textContent = 'ì™„ë£Œ';
  }catch(err){
    console.error(err);
    $('#status').textContent = 'ì˜¤ë¥˜: ' + (err?.message||err);
  }
});
$('#btn-export').addEventListener('click', ()=>{
  const report = window.__lastReport || {createdAt:new Date().toISOString(), note:'no data'};
  const blob = new Blob([JSON.stringify(report, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'deid_report.json';
  a.click();
});

/* ë°±ì—”ë“œ í›…(ì„ íƒ): window.API_BASEê°€ ì •ì˜ë˜ê³  #opt-backend ì²´í¬ ì‹œ
   - /extract (file) -> { full_text, pages[] }
   - /match   (text, rules[], options) -> { counts, items }
   í˜•ì‹ì„ ê°€ì •í•˜ê³  ì´ ë¶€ë¶„ì„ êµì²´í•˜ë©´ ë¨. ì§€ê¸ˆì€ í´ë¼ ëª¨ë“œë§Œ í™œì„±í™”. */
</script>
</body>
</html>
